<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>17ëª… í’€ë¦¬ê·¸ ì‹¤ì‹œê°„ ê²°ê³¼</title>
  <script>
    // =====================
    // ğŸ”§ CONFIGURATION
    // =====================
    // 1) Google Sheetsì—ì„œ 'ì›¹ì— ê²Œì‹œ' â†’ CSV ë§í¬ ë¶™ì—¬ë„£ê¸°
    // ì˜ˆ: const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/.../pub?gid=0&single=true&output=csv";
    // ì•„ë˜ëŠ” ë°ëª¨ìš© ìƒ˜í”Œ ë°ì´í„°(ì§ˆì˜íŒŒë¼ë¯¸í„° ?demo=1 ì‚¬ìš© ì‹œ ì ìš©)
    const SHEET_CSV_URL = ""; // ì—¬ê¸°ì— ì‹¤ì œ CSV URL ì…ë ¥

    // ìë™ ìƒˆë¡œê³ ì¹¨(ì´ˆ)
    const REFRESH_SEC = 30;

    // ìŠ¹ì  ê·œì¹™ (ì¶•êµ¬ì‹ ê¸°ë³¸ê°’)
    const POINTS = { win: 3, draw: 1, loss: 0 };

    // ì •ë ¬ ê¸°ì¤€: ìŠ¹ì >ë“ì‹¤ì°¨>ë“ì >ìƒëŒ€ì „ì (ì˜µì…˜)>ì´ë¦„
    const TIEBREAK = { headToHead: true };

    // íŒ€/ì„ ìˆ˜ ì´ë¦„ ì •ë ¬ ì‹œ ëŒ€ì†Œë¬¸ì êµ¬ë¶„ ì œê±°
    const norm = s => (s||"").toString().trim().toLowerCase();

    // =====================
    // ğŸ§® CORE LOGIC
    // =====================
    function parseCSV(text){
      // ë§¤ìš° ë‹¨ìˆœí•œ CSV íŒŒì„œ (ì‰¼í‘œ/ë”°ì˜´í‘œ ì²˜ë¦¬ ê¸°ë³¸)
      const rows = [];
      let i=0, field="", row=[]; let inQ=false;
      const pushField=()=>{ row.push(field); field=""; };
      const pushRow=()=>{ rows.push(row); row=[]; };
      while(i<text.length){
        const c = text[i++];
        if(inQ){
          if(c==='"'){
            if(text[i]==='"'){ field+='"'; i++; } else { inQ=false; }
          } else field+=c;
        } else {
          if(c==='"') inQ=true;
          else if(c===',') pushField();
          else if(c==='\n'){ pushField(); pushRow(); }
          else if(c==='\r'){ /* ignore */ }
          else field+=c;
        }
      }
      // ë§ˆì§€ë§‰ í•„ë“œ/í–‰ ì²˜ë¦¬
      if(field.length || row.length){ pushField(); pushRow(); }
      return rows;
    }

    function parseMatches(rows){
      // ê¸°ëŒ€ ìŠ¤í‚¤ë§ˆ (í—¤ë” ë°˜ë“œì‹œ í¬í•¨):
      // match_id,date,home,away,home_score,away_score
      // ì ìˆ˜ ë¹„ì–´ìˆìœ¼ë©´ ë¯¸ì™„ë£Œ ê²½ê¸°ë¡œ ê°„ì£¼
      const [header, ...data] = rows.filter(r=>r.length>1);
      if(!header) return { header:[], matches:[] };
      const idx = Object.fromEntries(header.map((h,i)=>[norm(h), i]));
      const req = ["match_id","date","home","away","home_score","away_score"];
      const ok = req.every(k=>idx.hasOwnProperty(k));
      if(!ok) {
        throw new Error("CSV í—¤ë”ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. í•„ìš”í•œ í—¤ë”: " + req.join(", "));
      }
      const matches = data.map(r=>({
        id: r[idx["match_id"]],
        date: r[idx["date"]],
        home: (r[idx["home"]]||"").trim(),
        away: (r[idx["away"]]||"").trim(),
        hs: r[idx["home_score"]]!==undefined && r[idx["home_score"]]!=="" ? Number(r[idx["home_score"]]) : null,
        as: r[idx["away_score"]]!==undefined && r[idx["away_score"]]!=="" ? Number(r[idx["away_score"]]) : null,
      })).filter(m=>m.home && m.away);
      return { header, matches };
    }

    function computeStandings(matches){
      const teams = new Map();
      const ensure = name => {
        if(!teams.has(name)) teams.set(name, {
          team: name, P:0, W:0, D:0, L:0, GF:0, GA:0, GD:0, Pts:0,
          form: [], // ìµœê·¼ 5ê²½ê¸° ê²°ê³¼
          playedWith: new Map(), // ìƒëŒ€ì „ì  ê³„ì‚°ìš©
        });
        return teams.get(name);
      };

      const completed = matches.filter(m=>Number.isFinite(m.hs) && Number.isFinite(m.as));
      completed.forEach(m=>{
        const H = ensure(m.home), A = ensure(m.away);
        H.P++; A.P++;
        H.GF+=m.hs; H.GA+=m.as; H.GD=H.GF-H.GA;
        A.GF+=m.as; A.GA+=m.hs; A.GD=A.GF-A.GA;

        let hr, ar; // result letters
        if(m.hs>m.as){
          H.W++; A.L++; H.Pts+=POINTS.win; A.Pts+=POINTS.loss; hr='W'; ar='L';
        } else if(m.hs<m.as){
          A.W++; H.L++; A.Pts+=POINTS.win; H.Pts+=POINTS.loss; hr='L'; ar='W';
        } else {
          H.D++; A.D++; H.Pts+=POINTS.draw; A.Pts+=POINTS.draw; hr='D'; ar='D';
        }
        H.form.push(hr); if(H.form.length>5) H.form.shift();
        A.form.push(ar); if(A.form.length>5) A.form.shift();

        // ìƒëŒ€ì „ì  ì§‘ê³„
        const keyHA = norm(A.team);
        const keyAH = norm(H.team);
        const vsH = H.playedWith.get(keyHA) || { pts:0, gd:0, gf:0 };
        const vsA = A.playedWith.get(keyAH) || { pts:0, gd:0, gf:0 };
        if(m.hs>m.as){ vsH.pts+=POINTS.win; vsA.pts+=POINTS.loss; }
        else if(m.hs<m.as){ vsA.pts+=POINTS.win; vsH.pts+=POINTS.loss; }
        else { vsH.pts+=POINTS.draw; vsA.pts+=POINTS.draw; }
        vsH.gd += (m.hs-m.as); vsH.gf += m.hs;
        vsA.gd += (m.as-m.hs); vsA.gf += m.as;
        H.playedWith.set(keyHA, vsH);
        A.playedWith.set(keyAH, vsA);
      });

      // ì •ë ¬
      const arr = Array.from(teams.values());
      arr.sort((a,b)=>{
        if(b.Pts!==a.Pts) return b.Pts-a.Pts;
        if(b.GD!==a.GD) return b.GD-a.GD;
        if(b.GF!==a.GF) return b.GF-a.GF;
        if(TIEBREAK.headToHead){
          const aVsB = a.playedWith.get(norm(b.team));
          const bVsA = b.playedWith.get(norm(a.team));
          if(aVsB && bVsA){
            if(bVsA.pts!==aVsB.pts) return bVsA.pts - aVsB.pts;
            if(bVsA.gd!==aVsB.gd) return bVsA.gd - aVsB.gd;
            if(bVsA.gf!==aVsB.gf) return bVsA.gf - aVsB.gf;
          }
        }
        return norm(a.team) < norm(b.team) ? -1 : 1;
      });

      // ìˆœìœ„ ë¶€ì—¬ (ê³µë™ìˆœìœ„ í—ˆìš©)
      let last = null, rank = 0;
      arr.forEach((t,i)=>{
        const key = `${t.Pts}|${t.GD}|${t.GF}`;
        if(last!==key){ rank = i+1; last = key; }
        t.Rank = rank;
      });

      return arr;
    }

    function groupUpcoming(matches){
      const upcoming = matches.filter(m=>!(Number.isFinite(m.hs) && Number.isFinite(m.as)));
      // ë‚ ì§œê°€ ìˆ«ì/ISOë©´ ì •ë ¬, ì•„ë‹ˆë©´ ê·¸ëŒ€ë¡œ
      upcoming.sort((a,b)=> (new Date(a.date)) - (new Date(b.date)));
      return upcoming;
    }

    // =====================
    // ğŸ–¥ï¸  UI RENDERING
    // =====================
    function el(tag, attrs={}, ...children){
      const e = document.createElement(tag);
      for(const [k,v] of Object.entries(attrs)){
        if(k==="class") e.className = v; else if(k==="html") e.innerHTML = v; else e.setAttribute(k,v);
      }
      children.flat().forEach(c=>{
        if(c==null) return;
        if(typeof c==="string" || typeof c==="number") e.appendChild(document.createTextNode(c));
        else e.appendChild(c);
      });
      return e;
    }

    function pill(text, title){
      const map = {W:"W", D:"D", L:"L"};
      const bg = {W:"bg-green-200", D:"bg-gray-200", L:"bg-red-200"}[text] || "bg-gray-100";
      return el("span", {class:`inline-flex items-center justify-center text-xs ${bg} rounded px-2 py-0.5`, title}, text);
    }

    function renderStandings(container, standings){
      container.innerHTML = "";
      const table = el("table", {class:"min-w-full border-separate border-spacing-y-2"});
      const thead = el("thead", {}, el("tr", {class:"text-sm text-gray-600"},
        ["ìˆœìœ„","ì„ ìˆ˜","ê²½ê¸°","ìŠ¹","ë¬´","íŒ¨","ë“ì ","ì‹¤ì ","ë“ì‹¤","ìŠ¹ì ","ìµœê·¼5"].map(h=>el("th", {class:"text-left px-3"}, h))
      ));
      const tbody = el("tbody");
      standings.forEach(t=>{
        const row = el("tr", {class:"bg-white shadow rounded"},
          el("td", {class:"px-3 py-2 font-medium"}, t.Rank),
          el("td", {class:"px-3 py-2"}, t.team),
          el("td", {class:"px-3 py-2"}, t.P),
          el("td", {class:"px-3 py-2"}, t.W),
          el("td", {class:"px-3 py-2"}, t.D),
          el("td", {class:"px-3 py-2"}, t.L),
          el("td", {class:"px-3 py-2"}, t.GF),
          el("td", {class:"px-3 py-2"}, t.GA),
          el("td", {class:"px-3 py-2"}, t.GD),
          el("td", {class:"px-3 py-2 font-bold"}, t.Pts),
          el("td", {class:"px-3 py-2"}, ...t.form.map((r,i)=>pill(r, `${t.team} ìµœê·¼ ${i+1}ë²ˆì§¸ ê²½ê¸°: ${r}`)))
        );
        tbody.appendChild(row);
      });
      table.appendChild(thead); table.appendChild(tbody);
      container.appendChild(table);
    }

    function renderUpcoming(container, upcoming){
      container.innerHTML = "";
      if(upcoming.length===0){
        container.appendChild(el("div", {class:"text-sm text-gray-600"}, "ì˜ˆì • ê²½ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤."));
        return;
      }
      const list = el("div", {class:"grid md:grid-cols-2 gap-3"});
      upcoming.slice(0, 20).forEach(m=>{
        list.appendChild(el("div", {class:"bg-white shadow rounded p-3"},
          el("div", {class:"text-xs text-gray-500"}, m.date || "ë‚ ì§œ ë¯¸ì •"),
          el("div", {class:"text-base font-medium mt-1"}, `${m.home} vs ${m.away}`)
        ));
      });
      container.appendChild(list);
    }

    function filterStandings(standings, q){
      if(!q) return standings;
      const n = norm(q);
      return standings.filter(t=> norm(t.team).includes(n));
    }

    // =====================
    // ğŸŒ DATA LOADING
    // =====================
    async function loadCSV(){
      const url = (new URLSearchParams(location.search).get('demo')) ? null : (SHEET_CSV_URL||null);
      if(!url){
        // ë°ëª¨ ë°ì´í„° (17ëª… ì¤‘ ì¼ë¶€ ê²½ê¸°ë§Œ ê¸°ì…)
        const demo = `match_id,date,home,away,home_score,away_score\n`
          + `1,2025-08-20,Alex,Bora,2,1\n`
          + `2,2025-08-20,Choi,Daun,1,1\n`
          + `3,2025-08-20,Eunji,Alex,0,3\n`
          + `4,2025-08-21,Bora,Choi,2,2\n`
          + `5,2025-08-21,Daun,Eunji,1,0\n`
          + `6,2025-08-22,Alex,Choi, , \n`
          + `7,2025-08-22,Bora,Eunji, , \n`
          + `8,2025-08-22,Daun,Faith, , \n`;
        return parseCSV(demo);
      }
      const res = await fetch(url, {cache:'no-store'});
      if(!res.ok) throw new Error("CSV ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: " + res.status);
      const text = await res.text();
      return parseCSV(text);
    }

    async function refresh(){
      const statusEl = document.getElementById('status');
      try{
        const rows = await loadCSV();
        const {matches} = parseMatches(rows);
        const standings = computeStandings(matches);
        const upcoming = groupUpcoming(matches);

        const q = document.getElementById('search').value;
        renderStandings(document.getElementById('standings'), filterStandings(standings, q));
        renderUpcoming(document.getElementById('upcoming'), upcoming);
        const now = new Date();
        statusEl.textContent = `ìë™ ì—…ë°ì´íŠ¸ ì¤‘ â€¢ ë§ˆì§€ë§‰ ìƒˆë¡œê³ ì¹¨: ${now.toLocaleString()} (ë§¤ ${REFRESH_SEC}ì´ˆ)`;
      } catch(err){
        statusEl.textContent = 'ì˜¤ë¥˜: ' + err.message;
        console.error(err);
      }
    }

    function scheduleAuto(){
      setInterval(refresh, REFRESH_SEC*1000);
    }

    // =====================
    // ğŸŒ“ THEME TOGGLE
    // =====================
    function toggleTheme(){
      document.documentElement.classList.toggle('dark');
      localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
    }

    function initTheme(){
      const saved = localStorage.getItem('theme');
      if(saved==='dark') document.documentElement.classList.add('dark');
    }

    // =====================
    // ğŸš€ INIT
    // =====================
    document.addEventListener('DOMContentLoaded', ()=>{
      initTheme();
      document.getElementById('search').addEventListener('input', ()=>refresh());
      document.getElementById('themeBtn').addEventListener('click', toggleTheme);
      refresh();
      scheduleAuto();
    });
  </script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{ color-scheme: light dark; }
    .dark body{ background:#0b1220; color:#e6edf3; }
    .dark .bg-white{ background:#0f172a !important; }
    .dark .text-gray-600{ color:#94a3b8 !important; }
    .dark .text-gray-500{ color:#94a3b8 !important; }
  </style>
</head>
<body class="min-h-screen bg-slate-50">
  <div class="max-w-6xl mx-auto p-4 md:p-6">
    <header class="flex items-center gap-3 mb-4">
      <h1 class="text-2xl md:text-3xl font-bold">17ëª… í’€ë¦¬ê·¸ ì‹¤ì‹œê°„ ê²°ê³¼</h1>
      <button id="themeBtn" class="ml-auto text-sm border px-3 py-1 rounded">ë¼ì´íŠ¸/ë‹¤í¬</button>
    </header>

    <section class="mb-4 bg-white dark:bg-slate-900 rounded p-3 shadow">
      <div class="flex flex-col md:flex-row md:items-center gap-3">
        <div class="text-sm" id="status">ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>
        <div class="md:ml-auto flex items-center gap-2">
          <input id="search" placeholder="ì„ ìˆ˜ ê²€ìƒ‰" class="border rounded px-3 py-1 text-sm bg-transparent" />
          <a class="text-xs underline" href="?demo=1">ë°ëª¨ ë³´ê¸°</a>
        </div>
      </div>
      <div class="text-xs text-gray-600 mt-2">CSV í—¤ë”ëŠ” <code>match_id,date,home,away,home_score,away_score</code> ì´ì–´ì•¼ í•©ë‹ˆë‹¤. ì ìˆ˜ê°€ ë¹„ì–´ ìˆìœ¼ë©´ ì˜ˆì • ê²½ê¸°ë¡œ ì²˜ë¦¬ë©ë‹ˆë‹¤.</div>
    </section>

    <main class="grid md:grid-cols-3 gap-6">
      <section class="md:col-span-2">
        <h2 class="text-xl font-semibold mb-2">ìˆœìœ„í‘œ</h2>
        <div id="standings" class="overflow-x-auto"></div>
      </section>
      <aside>
        <h2 class="text-xl font-semibold mb-2">ì˜ˆì • ê²½ê¸°</h2>
        <div id="upcoming"></div>
      </aside>
    </main>

    <footer class="mt-10 text-xs text-gray-600">
      <p>â€¢ Google Sheetsì—ì„œ ê²°ê³¼ë¥¼ ì…ë ¥í•˜ë©´ ì´ í˜ì´ì§€ê°€ ìë™ìœ¼ë¡œ ì§‘ê³„/ì •ë ¬í•˜ì—¬ ë³´ì—¬ì¤ë‹ˆë‹¤. (ê¸°ë³¸ 30ì´ˆë§ˆë‹¤ ìƒˆë¡œê³ ì¹¨)</p>
      <p>â€¢ ë™ë¥  ì‹œ ìŠ¹ì â†’ë“ì‹¤ì°¨â†’ë“ì â†’ìƒëŒ€ì „ì  ìˆœìœ¼ë¡œ ì •ë ¬í•©ë‹ˆë‹¤. í•„ìš” ì‹œ ìŠ¤í¬ë¦½íŠ¸ ìƒë‹¨ì˜ TIEBREAK ì„¤ì •ì„ ìˆ˜ì •í•˜ì„¸ìš”.</p>
    </footer>
  </div>
</body>
</html>
