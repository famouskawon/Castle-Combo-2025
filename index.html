<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>17Î™Ö ÌíÄÎ¶¨Í∑∏ Ïã§ÏãúÍ∞Ñ Í≤∞Í≥º</title>
  <script>
    // =====================
    // üîß CONFIGURATION
    // =====================
    // 1) Google SheetsÏóêÏÑú 'ÏõπÏóê Í≤åÏãú' ‚Üí CSV ÎßÅÌÅ¨ Î∂ôÏó¨ÎÑ£Í∏∞
    // Ïòà: const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/.../pub?gid=0&single=true&output=csv";
    // ÏïÑÎûòÎäî Îç∞Î™®Ïö© ÏÉòÌîå Îç∞Ïù¥ÌÑ∞(ÏßàÏùòÌååÎùºÎØ∏ÌÑ∞ ?demo=1 ÏÇ¨Ïö© Ïãú Ï†ÅÏö©)
    const SHEET_CSV_URL = ""; // Ïó¨Í∏∞Ïóê Ïã§Ï†ú CSV URL ÏûÖÎ†•

    // ÏûêÎèô ÏÉàÎ°úÍ≥†Ïπ®(Ï¥à)
    const REFRESH_SEC = 30;

    // ÏäπÏ†ê Í∑úÏπô (Ï∂ïÍµ¨Ïãù Í∏∞Î≥∏Í∞í)
    const POINTS = { win: 3, draw: 1, loss: 0 };

    // Ï†ïÎ†¨ Í∏∞Ï§Ä: ÏäπÏ†ê>ÎìùÏã§Ï∞®>ÎìùÏ†ê>ÏÉÅÎåÄÏ†ÑÏ†Å(ÏòµÏÖò)>Ïù¥Î¶Ñ
    const TIEBREAK = { headToHead: true };

    // ÌåÄ/ÏÑ†Ïàò Ïù¥Î¶Ñ Ï†ïÎ†¨ Ïãú ÎåÄÏÜåÎ¨∏Ïûê Íµ¨Î∂Ñ Ï†úÍ±∞
    const norm = s => (s||"").toString().trim().toLowerCase();

    // =====================
    // üßÆ CORE LOGIC
    // =====================
    function parseCSV(text){
      // Îß§Ïö∞ Îã®ÏàúÌïú CSV ÌååÏÑú (ÏâºÌëú/Îî∞Ïò¥Ìëú Ï≤òÎ¶¨ Í∏∞Î≥∏)
      const rows = [];
      let i=0, field="", row=[]; let inQ=false;
      const pushField=()=>{ row.push(field); field=""; };
      const pushRow=()=>{ rows.push(row); row=[]; };
      while(i<text.length){
        const c = text[i++];
        if(inQ){
          if(c==='"'){
            if(text[i]==='"'){ field+='"'; i++; } else { inQ=false; }
          } else field+=c;
        } else {
          if(c==='"') inQ=true;
          else if(c===',') pushField();
          else if(c==='\n'){ pushField(); pushRow(); }
          else if(c==='\r'){ /* ignore */ }
          else field+=c;
        }
      }
      // ÎßàÏßÄÎßâ ÌïÑÎìú/Ìñâ Ï≤òÎ¶¨
      if(field.length || row.length){ pushField(); pushRow(); }
      return rows;
    }

    function parseMatches(rows){
      // Í∏∞ÎåÄ Ïä§ÌÇ§Îßà (Ìó§Îçî Î∞òÎìúÏãú Ìè¨Ìï®):
      // match_id,date,home,away,home_score,away_score
      // Ï†êÏàò ÎπÑÏñ¥ÏûàÏúºÎ©¥ ÎØ∏ÏôÑÎ£å Í≤ΩÍ∏∞Î°ú Í∞ÑÏ£º
      const [header, ...data] = rows.filter(r=>r.length>1);
      if(!header) return { header:[], matches:[] };
      const idx = Object.fromEntries(header.map((h,i)=>[norm(h), i]));
      const req = ["match_id","date","home","away","home_score","away_score"];
      const ok = req.every(k=>idx.hasOwnProperty(k));
      if(!ok) {
        throw new Error("CSV Ìó§ÎçîÍ∞Ä Ïò¨Î∞îÎ•¥ÏßÄ ÏïäÏäµÎãàÎã§. ÌïÑÏöîÌïú Ìó§Îçî: " + req.join(", "));
      }
      const matches = data.map(r=>({
        id: r[idx["match_id"]],
        date: r[idx["date"]],
        home: (r[idx["home"]]||"").trim(),
        away: (r[idx["away"]]||"").trim(),
        hs: r[idx["home_score"]]!==undefined && r[idx["home_score"]]!=="" ? Number(r[idx["home_score"]]) : null,
        as: r[idx["away_score"]]!==undefined && r[idx["away_score"]]!=="" ? Number(r[idx["away_score"]]) : null,
      })).filter(m=>m.home && m.away);
      return { header, matches };
    }

    function computeStandings(matches){
      const teams = new Map();
      const ensure = name => {
        if(!teams.has(name)) teams.set(name, {
          team: name, P:0, W:0, D:0, L:0, GF:0, GA:0, GD:0, Pts:0,
          form: [], // ÏµúÍ∑º 5Í≤ΩÍ∏∞ Í≤∞Í≥º
          playedWith: new Map(), // ÏÉÅÎåÄÏ†ÑÏ†Å Í≥ÑÏÇ∞Ïö©
        });
        return teams.get(name);
      };

      const completed = matches.filter(m=>Number.isFinite(m.hs) && Number.isFinite(m.as));
      completed.forEach(m=>{
        const H = ensure(m.home), A = ensure(m.away);
        H.P++; A.P++;
        H.GF+=m.hs; H.GA+=m.as; H.GD=H.GF-H.GA;
        A.GF+=m.as; A.GA+=m.hs; A.GD=A.GF-A.GA;

        let hr, ar; // result letters
        if(m.hs>m.as){
          H.W++; A.L++; H.Pts+=POINTS.win; A.Pts+=POINTS.loss; hr='W'; ar='L';
        } else if(m.hs<m.as){
          A.W++; H.L++; A.Pts+=POINTS.win; H.Pts+=POINTS.loss; hr='L'; ar='W';
        } else {
          H.D++; A.D++; H.Pts+=POINTS.draw; A.Pts+=POINTS.draw; hr='D'; ar='D';
        }
        H.form.push(hr); if(H.form.length>5) H.form.shift();
        A.form.push(ar); if(A.form.length>5) A.form.shift();

        // ÏÉÅÎåÄÏ†ÑÏ†Å ÏßëÍ≥Ñ
        const keyHA = norm(A.team);
        const keyAH = norm(H.team);
        const vsH = H.playedWith.get(keyHA) || { pts:0, gd:0, gf:0 };
        const vsA = A.playedWith.get(keyAH) || { pts:0, gd:0, gf:0 };
        if(m.hs>m.as){ vsH.pts+=POINTS.win; vsA.pts+=POINTS.loss; }
        else if(m.hs<m.as){ vsA.pts+=POINTS.win; vsH.pts+=POINTS.loss; }
        else { vsH.pts+=POINTS.draw; vsA.pts+=POINTS.draw; }
        vsH.gd += (m.hs-m.as); vsH.gf += m.hs;
        vsA.gd += (m.as-m.hs); vsA.gf += m.as;
        H.playedWith.set(keyHA, vsH);
        A.playedWith.set(keyAH, vsA);
      });

      // Ï†ïÎ†¨
      const arr = Array.from(teams.values());
      arr.sort((a,b)=>{
        if(b.Pts!==a.Pts) return b.Pts-a.Pts;
        if(b.GD!==a.GD) return b.GD-a.GD;
        if(b.GF!==a.GF) return b.GF-a.GF;
        if(TIEBREAK.headToHead){
          const aVsB = a.playedWith.get(norm(b.team));
          const bVsA = b.playedWith.get(norm(a.team));
          if(aVsB && bVsA){
            if(bVsA.pts!==aVsB.pts) return bVsA.pts - aVsB.pts;
            if(bVsA.gd!==aVsB.gd) return bVsA.gd - aVsB.gd;
            if(bVsA.gf!==aVsB.gf) return bVsA.gf - aVsB.gf;
          }
        }
        return norm(a.team) < norm(b.team) ? -1 : 1;
      });

      // ÏàúÏúÑ Î∂ÄÏó¨ (Í≥µÎèôÏàúÏúÑ ÌóàÏö©)
      let last = null, rank = 0;
      arr.forEach((t,i)=>{
        const key = `${t.Pts}|${t.GD}|${t.GF}`;
        if(last!==key){ rank = i+1; last = key; }
        t.Rank = rank;
      });

      return arr;
    }

    function groupUpcoming(matches){
      const upcoming = matches.filter(m=>!(Number.isFinite(m.hs) && Number.isFinite(m.as)));
      // ÎÇ†ÏßúÍ∞Ä Ïà´Ïûê/ISOÎ©¥ Ï†ïÎ†¨, ÏïÑÎãàÎ©¥ Í∑∏ÎåÄÎ°ú
      upcoming.sort((a,b)=> (new Date(a.date)) - (new Date(b.date)));
      return upcoming;
    }

    // =====================
    // üñ•Ô∏è  UI RENDERING
    // =====================
    function el(tag, attrs={}, ...children){
      const e = document.createElement(tag);
      for(const [k,v] of Object.entries(attrs)){
        if(k==="class") e.className = v; else if(k==="html") e.innerHTML = v; else e.setAttribute(k,v);
      }
      children.flat().forEach(c=>{
        if(c==null) return;
        if(typeof c==="string" || typeof c==="number") e.appendChild(document.createTextNode(c));
        else e.appendChild(c);
      });
      return e;
    }

    function pill(text, title){
      const map = {W:"W", D:"D", L:"L"};
      const bg = {W:"bg-green-200", D:"bg-gray-200", L:"bg-red-200"}[text] || "bg-gray-100";
      return el("span", {class:`inline-flex items-center justify-center text-xs ${bg} rounded px-2 py-0.5`, title}, text);
    }

    function renderStandings(container, standings){
      container.innerHTML = "";
      const table = el("table", {class:"min-w-full border-separate border-spacing-y-2"});
      const thead = el("thead", {}, el("tr", {class:"text-sm text-gray-600"},
        ["ÏàúÏúÑ","ÏÑ†Ïàò","Í≤ΩÍ∏∞","Ïäπ","Î¨¥","Ìå®","ÎìùÏ†ê","Ïã§Ï†ê","ÎìùÏã§","ÏäπÏ†ê","ÏµúÍ∑º5"].map(h=>el("th", {class:"text-left px-3"}, h))
      ));
      const tbody = el("tbody");
      standings.forEach(t=>{
        const row = el("tr", {class:"bg-white shadow rounded"},
          el("td", {class:"px-3 py-2 font-medium"}, t.Rank),
          el("td", {class:"px-3 py-2"}, t.team),
          el("td", {class:"px-3 py-2"}, t.P),
          el("td", {class:"px-3 py-2"}, t.W),
          el("td", {class:"px-3 py-2"}, t.D),
          el("td", {class:"px-3 py-2"}, t.L),
          el("td", {class:"px-3 py-2"}, t.GF),
          el("td", {class:"px-3 py-2"}, t.GA),
          el("td", {class:"px-3 py-2"}, t.GD),
          el("td", {class:"px-3 py-2 font-bold"}, t.Pts),
          el("td", {class:"px-3 py-2"}, ...t.form.map((r,i)=>pill(r, `${t.team} ÏµúÍ∑º ${i+1}Î≤àÏß∏ Í≤ΩÍ∏∞: ${r}`)))
        );
        tbody.appendChild(row);
      });
      table.appendChild(thead); table.appendChild(tbody);
      container.appendChild(table);
    }

    function renderUpcoming(container, upcoming){
      container.innerHTML = "";
      if(upcoming.length===0){
        container.appendChild(el("div", {class:"text-sm text-gray-600"}, "ÏòàÏ†ï Í≤ΩÍ∏∞Í∞Ä ÏóÜÏäµÎãàÎã§."));
        return;
      }
      const list = el("div", {class:"grid md:grid-cols-2 gap-3"});
      upcoming.slice(0, 20).forEach(m=>{
        list.appendChild(el("div", {class:"bg-white shadow rounded p-3"},
          el("div", {class:"text-xs text-gray-500"}, m.date || "ÎÇ†Ïßú ÎØ∏Ï†ï"),
          el("div", {class:"text-base font-medium mt-1"}, `${m.home} vs ${m.away}`)
        ));
      });
      container.appendChild(list);
    }

    function filterStandings(standings, q){
      if(!q) return standings;
      const n = norm(q);
      return standings.filter(t=> norm(t.team).includes(n));
    }

    // =====================
    // üåê DATA LOADING
    // =====================
    async function loadCSV(){
      const url = (new URLSearchParams(location.search).get('demo')) ? null : (SHEET_CSV_URL||null);
      if(!url){
        // Îç∞Î™® Îç∞Ïù¥ÌÑ∞ (17Î™Ö Ï§ë ÏùºÎ∂Ä Í≤ΩÍ∏∞Îßå Í∏∞ÏûÖ)
        const demo = `match_id,date,home,away,home_score,away_score\n`
          + `1,2025-08-20,Alex,Bora,2,1\n`
          + `2,2025-08-20,Choi,Daun,1,1\n`
          + `3,2025-08-20,Eunji,Alex,0,3\n`
          + `4,2025-08-21,Bora,Choi,2,2\n`
          + `5,2025-08-21,Daun,Eunji,1,0\n`
          + `6,2025-08-22,Alex,Choi, , \n`
          + `7,2025-08-22,Bora,Eunji, , \n`
          + `8,2025-08-22,Daun,Faith, , \n`;
        return parseCSV(demo);
      }
      const res = await fetch(url, {cache:'no-store'});
      if(!res.ok) throw new Error("CSV Î∂àÎü¨Ïò§Í∏∞ Ïã§Ìå®: " + res.status);
      const text = await res.text();
      return parseCSV(text);
    }

    async function refresh(){
      const statusEl = document.getElementById('status');
      try{
        const rows = await loadCSV();
        const {matches} = parseMatches(rows);
        const standings = computeStandings(matches);
        const upcoming = groupUpcoming(matches);

        const q = document.getElementById('search').value;
        renderStandings(document.getElementById('standings'), filterStandings(standings, q));
        renderUpcoming(document.getElementById('upcoming'), upcoming);
        const now = new Date();
        statusEl.textContent = `ÏûêÎèô ÏóÖÎç∞Ïù¥Ìä∏ Ï§ë ‚Ä¢ ÎßàÏßÄÎßâ ÏÉàÎ°úÍ≥†Ïπ®: ${now.toLocaleString()} (Îß§ ${REFRESH_SEC}Ï¥à)`;
      } catch(err){
        statusEl.textContent = 'Ïò§Î•ò: ' + err.message;
        console.error(err);
      }
    }

    function scheduleAuto(){
      setInterval(refresh, REFRESH_SEC*1000);
    }

    // =====================
    // üåì THEME TOGGLE
    // =====================
    function toggleTheme(){
      document.documentElement.classList.toggle('dark');
      localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
    }

    function initTheme(){
      const saved = localStorage.getItem('theme');
      if(saved==='dark') document.documentElement.classList.add('dark');
    }

    // =====================
    // üöÄ INIT
    // =====================
    document.addEventListener('DOMContentLoaded', ()=>{
      initTheme();
      document.getElementById('search').addEventListener('input', ()=>refresh());
      document.getElementById('themeBtn').addEventListener('click', toggleTheme);
      refresh();
      scheduleAuto();
    });
  </script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{ color-scheme: light dark; }
    .dark body{ background:#0b1220; color:#e6edf3; }
    .dark .bg-white{ background:#0f172a !important; }
    .dark .text-gray-600{ color:#94a3b8 !important; }
    .dark .text-gray-500{ color:#94a3b8 !important; }
  </style>
</head>
<body class="min-h-screen bg-slate-50">
  <div class="max-w-6xl mx-auto p-4 md:p-6">
    <header class="flex items-center gap-3 mb-4">
      <h1 class="text-2xl md:text-3xl font-bold">17Î™Ö ÌíÄÎ¶¨Í∑∏ Ïã§ÏãúÍ∞Ñ Í≤∞Í≥º</h1>
      <button id="themeBtn" class="ml-auto text-sm border px-3 py-1 rounded">ÎùºÏù¥Ìä∏/Îã§ÌÅ¨</button>
    </header>

    <section class="mb-4 bg-white dark:bg-slate-900 rounded p-3 shadow">
      <div class="flex flex-col md:flex-row md:items-center gap-3">
        <div class="text-sm" id="status">Îç∞Ïù¥ÌÑ∞ Î∂àÎü¨Ïò§Îäî Ï§ë‚Ä¶</div>
        <div class="md:ml-auto flex items-center gap-2">
          <input id="search" placeholder="ÏÑ†Ïàò Í≤ÄÏÉâ" class="border rounded px-3 py-1 text-sm bg-transparent" />
          <a class="text-xs underline" href="?demo=1">Îç∞Î™® Î≥¥Í∏∞</a>
        </div>
      </div>
      <div class="text-xs text-gray-600 mt-2">CSV Ìó§ÎçîÎäî <code>match_id,date,home,away,home_score,away_score</code> Ïù¥Ïñ¥Ïïº Ìï©ÎãàÎã§. Ï†êÏàòÍ∞Ä ÎπÑÏñ¥ ÏûàÏúºÎ©¥ ÏòàÏ†ï Í≤ΩÍ∏∞Î°ú Ï≤òÎ¶¨Îê©ÎãàÎã§.</div>
    </section>

    <main class="grid md:grid-cols-3 gap-6">
      <section class="md:col-span-2">
        <h2 class="text-xl font-semibold mb-2">ÏàúÏúÑÌëú</h2>
        <div id="standings" class="overflow-x-auto"></div>
      </section>
      <aside>
        <h2 class="text-xl font-semibold mb-2">ÏòàÏ†ï Í≤ΩÍ∏∞</h2>
        <div id="upcoming"></div>
      </aside>
    </main>

    <footer class="mt-10 text-xs text-gray-600">
      <p>‚Ä¢ Google SheetsÏóêÏÑú Í≤∞Í≥ºÎ•º ÏûÖÎ†•ÌïòÎ©¥ Ïù¥ ÌéòÏù¥ÏßÄÍ∞Ä ÏûêÎèôÏúºÎ°ú ÏßëÍ≥Ñ/Ï†ïÎ†¨ÌïòÏó¨ Î≥¥Ïó¨Ï§çÎãàÎã§. (Í∏∞Î≥∏ 30Ï¥àÎßàÎã§ ÏÉàÎ°úÍ≥†Ïπ®)</p>
      <p>‚Ä¢ ÎèôÎ•† Ïãú ÏäπÏ†ê‚ÜíÎìùÏã§Ï∞®‚ÜíÎìùÏ†ê‚ÜíÏÉÅÎåÄÏ†ÑÏ†Å ÏàúÏúºÎ°ú Ï†ïÎ†¨Ìï©ÎãàÎã§. ÌïÑÏöî Ïãú Ïä§ÌÅ¨Î¶ΩÌä∏ ÏÉÅÎã®Ïùò TIEBREAK ÏÑ§Ï†ïÏùÑ ÏàòÏ†ïÌïòÏÑ∏Ïöî.</p>
    </footer>
  </div>
</body>
</html>
