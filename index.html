<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>17명 풀리그 실시간 결과</title>
  <script>
    const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQld5cXTGJFmtSWvWeZrmlBzGVol9VnkacTqlBvKA65hmSg8QpYdiJQjvNF48b5t-tuFVHRXxqFj78W/pub?gid=0&single=true&output=csv"; // 실제 구글 시트 CSV URL 넣기
    const REFRESH_SEC = 30;

    const norm = s => (s||"").toString().trim().toLowerCase();

    function parseCSV(text){
      const rows = [];
      let i=0, field="", row=[]; let inQ=false;
      const pushField=()=>{ row.push(field); field=""; };
      const pushRow=()=>{ rows.push(row); row=[]; };
      while(i<text.length){
        const c = text[i++];
        if(inQ){
          if(c==='"'){
            if(text[i]==='"'){ field+='"'; i++; } else { inQ=false; }
          } else field+=c;
        } else {
          if(c==='"') inQ=true;
          else if(c===',') pushField();
          else if(c==='\n'){ pushField(); pushRow(); }
          else if(c==='\r'){ }
          else field+=c;
        }
      }
      if(field.length || row.length){ pushField(); pushRow(); }
      return rows;
    }

    function parseMatches(rows){
      const [header, ...data] = rows.filter(r=>r.length>1);
      if(!header) return { header:[], matches:[] };
      const idx = Object.fromEntries(header.map((h,i)=>[norm(h), i]));
      const matches = data.map(r=>({
        id: r[idx["match_id"]],
        date: r[idx["date"]],
        home: (r[idx["home"]]||"").trim(),
        away: (r[idx["away"]]||"").trim(),
        hs: r[idx["home_score"]]!==undefined && r[idx["home_score"]]!=="" ? Number(r[idx["home_score"]]) : null,
        as: r[idx["away_score"]]!==undefined && r[idx["away_score"]]!=="" ? Number(r[idx["away_score"]]) : null,
      })).filter(m=>m.home && m.away);
      return { header, matches };
    }

    function computeStandings(matches){
      const teams = new Map();
      const ensure = name => {
        if(!teams.has(name)) teams.set(name, {
          team: name, P:0, W:0, L:0, GF:0, GA:0, GD:0, form: [] });
        return teams.get(name);
      };

      const PLAYERS = ["근근","깡","다루","다니","라로","로버트","미정","소금","소나","숑숑","승지","아르테","위나","지명","쿠몬","큰환","하늘"];
      PLAYERS.forEach(p=>ensure(p));

      const completed = matches.filter(m=>Number.isFinite(m.hs) && Number.isFinite(m.as));
      completed.forEach(m=>{
        const H = ensure(m.home), A = ensure(m.away);
        if(m.hs===m.as){ return; } // 무승부 제외
        H.P++; A.P++;
        H.GF+=m.hs; H.GA+=m.as; H.GD=H.GF-H.GA;
        A.GF+=m.as; A.GA+=m.hs; A.GD=A.GF-A.GA;
        if(m.hs>m.as){ H.W++; A.L++; H.form.push('W'); A.form.push('L'); }
        else { A.W++; H.L++; A.form.push('W'); H.form.push('L'); }
        if(H.form.length>5) H.form.shift();
        if(A.form.length>5) A.form.shift();
      });

      const arr = Array.from(teams.values());
      arr.sort((a,b)=>{
        if(b.GD!==a.GD) return b.GD-a.GD;
        if(b.GF!==a.GF) return b.GF-a.GF;
        return (a.team.localeCompare(b.team,'ko'));
      });
      return arr;
    }

    function groupUpcoming(matches){
      return matches.filter(m=>!(Number.isFinite(m.hs) && Number.isFinite(m.as)));
    }

    function el(tag, attrs={}, ...children){
      const e = document.createElement(tag);
      for(const [k,v] of Object.entries(attrs)){
        if(k==="class") e.className = v; else if(k==="html") e.innerHTML = v; else e.setAttribute(k,v);
      }
      children.flat().forEach(c=>{ if(c==null)return; if(typeof c=="string"||typeof c=="number") e.appendChild(document.createTextNode(c)); else e.appendChild(c); });
      return e;
    }
    function pill(text,title){
      const bg = {W:"bg-green-200",L:"bg-red-200"}[text]||"bg-gray-100";
      return el("span",{class:`inline-flex items-center justify-center text-xs ${bg} rounded px-2 py-0.5`,title},text);
    }

    function renderStandings(container, standings){
      container.innerHTML="";
      const table = el("table",{class:"min-w-full border-separate border-spacing-y-2"});
      const thead = el("thead",{}, el("tr",{class:"text-sm text-gray-600"},
        ["선수","경기","승","패","득실","최근5"].map(h=>el("th",{class:"text-left px-3"},h))));
      const tbody = el("tbody");
      standings.forEach(t=>{
        const row = el("tr",{class:"bg-white shadow rounded"},
          el("td",{class:"px-3 py-2"},t.team),
          el("td",{class:"px-3 py-2"},t.P),
          el("td",{class:"px-3 py-2"},t.W),
          el("td",{class:"px-3 py-2"},t.L),
          el("td",{class:"px-3 py-2"},t.GD),
          el("td",{class:"px-3 py-2"},...t.form.map((r,i)=>pill(r,`${t.team} 최근 ${i+1}번째 경기: ${r}`)))
        );
        tbody.appendChild(row);
      });
      table.appendChild(thead); table.appendChild(tbody);
      container.appendChild(table);
    }

    async function loadCSV(){
      if(!SHEET_CSV_URL){
        const demo = `match_id,date,home,away,home_score,away_score\n`
          + `1,2025-08-20,근근,깡,2,1\n`
          + `2,2025-08-20,다루,다니,3,0\n`;
        return parseCSV(demo);
      }
      const res = await fetch(SHEET_CSV_URL,{cache:'no-store'});
      const text = await res.text();
      return parseCSV(text);
    }

    async function refresh(){
      const statusEl=document.getElementById('status');
      try{
        const rows=await loadCSV();
        const {matches}=parseMatches(rows);
        const standings=computeStandings(matches);
        renderStandings(document.getElementById('standings'),standings);
        statusEl.textContent=`업데이트: ${new Date().toLocaleString()}`;
      }catch(err){ statusEl.textContent='오류: '+err.message; }
    }

    document.addEventListener('DOMContentLoaded',()=>{
      refresh(); setInterval(refresh,REFRESH_SEC*1000);
    });
  </script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-slate-50">
  <div class="max-w-4xl mx-auto p-4">
    <h1 class="text-2xl font-bold mb-2">17명 풀리그 실시간 결과</h1>
    <div id="status" class="text-sm text-gray-600 mb-4">불러오는 중…</div>
    <div id="standings"></div>
    <div class="mt-6 text-xs text-gray-500">CSV 헤더: match_id,date,home,away,home_score,away_score. 무승부 입력시 무시됨.</div>
  </div>
</body>
</html>
